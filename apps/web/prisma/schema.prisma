// Prisma schema for BNPL merchant applications
generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model MerchantApplication {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Core identification
  applicantAddress String  // Stellar public key
  contractId       String  // BNPL contract ID (used as key, not stored on blockchain)
  
  // This is what gets stored on blockchain
  blockchainId     String? // MongoDB ObjectID stored on blockchain for reference
  
  // Application status
  status           ApplicationStatus @default(DRAFT)
  submittedAt      DateTime?
  reviewedAt       DateTime?
  reviewedBy       String?         // Admin address
  rejectionReason  String?
  riskScore        Int?

  // Business Information
  businessInfo BusinessInfo

  // Contact Information  
  contactInfo ContactInfo

  // KYB Documents
  documents KYBDocuments

  // Banking Information
  bankingInfo BankingInfo

  // Blockchain tracking
  blockchainTxHash        String?
  isBlockchainCommitted   Boolean @default(false)
  blockchainCommitAttempts Int    @default(0)
  lastBlockchainAttempt   DateTime?

  // Composite unique constraint - one application per address per contract
  @@unique([applicantAddress, contractId])
  
  // Indexes for performance
  @@index([applicantAddress])
  @@index([contractId])
  @@index([status])
  @@index([blockchainId])
  @@map("merchant_applications")
}

type BusinessInfo {
  legalName         String
  tradingName       String
  registrationNumber String
  taxId            String
  category         String
  subcategory      String
  yearEstablished  Int
  monthlyVolume    Float
  website          String
  description      String
  businessAddress  AddressInfo
}

type ContactInfo {
  primaryContact   ContactPerson
  technicalContact ContactPerson?
  financialContact ContactPerson?
}

type ContactPerson {
  firstName String
  lastName  String
  title     String
  email     String
  phone     String
}

type AddressInfo {
  street     String
  city       String
  state      String
  postalCode String
  country    String
}

type KYBDocuments {
  businessRegistration DocumentInfo
  taxCertificate       DocumentInfo
  bankStatement        DocumentInfo
  utilityBill         DocumentInfo
  additionalDocs      DocumentInfo[]
}

type DocumentInfo {
  documentType      String
  fileHash         String
  uploadedAt       DateTime
  verified         Boolean @default(false)
  verificationNotes String?
}

type BankingInfo {
  accountName   String
  accountNumber String
  routingNumber String
  bankName      String
  swiftCode     String?
}

enum ApplicationStatus {
  DRAFT
  SUBMITTED
  UNDER_REVIEW
  DOCUMENTS_NEEDED
  APPROVED
  REJECTED
  SUSPENDED
}

// Admin management
model AdminUser {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  
  address     String @unique // Stellar public key
  role        AdminRole @default(REVIEWER)
  permissions String[] // Array of permission strings
  isActive    Boolean @default(true)
  
  // Audit trail
  applicationsReviewed String[] @db.ObjectId // References to MerchantApplication ids
  lastActivity        DateTime?
  
  @@map("admin_users")
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  REVIEWER
}

// System configuration per contract deployment
model ContractConfig {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  contractId     String @unique // BNPL contract address (Stellar contract ID)
  networkType    String         // "testnet" | "mainnet"
  deployedAt     DateTime
  isActive       Boolean @default(true)
  
  // Configuration settings
  settings       Json // Flexible config object
  
  @@map("contract_configs")
}

// Track blockchain references
model BlockchainReference {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  
  // Links MongoDB document to blockchain
  mongoId        String // MongoDB ObjectID of the referenced document
  contractId     String // Which BNPL contract this reference is stored in
  referenceType  String // "merchant_application" | "loan" | "bill" | etc.
  txHash         String // Transaction hash where this was stored
  
  @@unique([mongoId, contractId])
  @@index([contractId])
  @@map("blockchain_references")
}

// ============================================
// Event Indexer Models (SCF #39 Requirement)
// ============================================

// Indexed contract events from Stellar blockchain
model ContractEvent {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // Event identification
  contractId    String   // Which contract emitted the event
  eventType     EventType
  ledger        Int      // Ledger sequence number
  txHash        String   // Transaction hash
  timestamp     DateTime // Event timestamp from ledger

  // Event data (flexible JSON for different event types)
  data          Json

  // Processing status
  processed     Boolean @default(false)
  processedAt   DateTime?

  @@unique([txHash, eventType])
  @@index([contractId])
  @@index([eventType])
  @@index([timestamp])
  @@index([ledger])
  @@map("contract_events")
}

enum EventType {
  // BNPL Core events
  BILL_CREATED
  BILL_PAID
  BILL_REPAID
  BILL_LIQUIDATED
  MERCHANT_ENROLLED
  // LP Token events
  DEPOSIT
  WITHDRAW
  BORROW
  REPAY
  // Token events
  TRANSFER
  MINT
  BURN
}

// Protocol metrics snapshot (aggregated periodically)
model ProtocolMetrics {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  contractId    String   // BNPL contract ID
  snapshotAt    DateTime // When this snapshot was taken

  // Core metrics
  tvl               Float    // Total Value Locked in USDC
  totalBorrowed     Float    // Total amount borrowed
  utilizationRate   Float    // borrowed / tvl * 100

  // User metrics
  totalUsers        Int      // Unique user addresses
  totalMerchants    Int      // Enrolled merchants

  // Transaction metrics
  totalBills        Int      // Total bills created
  activeBills       Int      // Bills in PAID status
  totalTransactions Int      // Total protocol transactions

  // Revenue metrics
  totalFees         Float    // Total fees collected
  totalLateFees     Float    // Late payment fees

  @@index([contractId])
  @@index([snapshotAt])
  @@map("protocol_metrics")
}

// Cursor for event streaming (track last processed ledger)
model IndexerCursor {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  updatedAt DateTime @updatedAt

  contractId    String @unique
  lastLedger    Int    // Last processed ledger sequence
  lastTxHash    String? // Last processed transaction

  @@map("indexer_cursors")
}

// Bill model for BNPL purchases (Simplified for POC)
model Bill {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Core identification
  contractId       String  // BNPL contract ID (to filter bills by contract)
  merchantAddress  String  // Merchant Stellar address
  userAddress      String  // User/Buyer Stellar address
  
  // This is what gets stored on blockchain
  onChainBillId    Int?    // The bill ID assigned by the smart contract
  
  // Bill details (simple)
  amount           Float   // Total bill amount in USDC
  description      String  // What the purchase is for
  
  // Merchant info (simple)
  merchantName     String
  
  // Composite unique constraint - one bill ID per contract
  @@unique([onChainBillId, contractId])
  
  // Indexes
  @@index([merchantAddress])
  @@index([userAddress])
  @@index([contractId])
  @@index([contractId, userAddress])
  @@index([contractId, merchantAddress])
  @@map("bills")
}

// ============================================
// Testnet Bot Models
// ============================================

// Bot state persistence
model BotState {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  updatedAt DateTime? @updatedAt

  // Contract identification
  contractId String // BNPL contract ID

  // Running status
  isRunning  Boolean   @default(false)
  startedAt  DateTime?
  stoppedAt  DateTime?

  // Daily statistics (reset daily)
  dailyStatsDate    String? // YYYY-MM-DD format
  dailyTxCount      Int?    @default(0)
  dailySuccessCount Int?    @default(0)
  dailyFailureCount Int?    @default(0)
  dailyVolume       Float?  @default(0) // Daily transaction volume in USDC
  dailyScenarios    Json?   // { "scenario_name": count }

  // Cumulative statistics
  totalVolume       Float?  @default(0) // Total transaction volume in USDC

  // Account pool state
  accountPool Json? // Full account pool state

  // Goal progress snapshot
  goalProgress Json? // Current goal progress

  @@index([contractId])
  @@map("bot_state")
}

// Bot activity log
model BotActivity {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // Contract identification
  contractId String // BNPL contract ID

  // Activity info
  date      String   // YYYY-MM-DD for easy querying
  scenario  String   // Scenario type executed
  success   Boolean
  details   Json?    // Scenario result details
  error     String?  // Error message if failed
  volume    Float?   // Transaction volume in USDC (if applicable)

  // Timing
  duration  Int?     // Execution time in ms

  @@index([contractId])
  @@index([contractId, date])
  @@index([date])
  @@index([scenario])
  @@index([success])
  @@index([createdAt])
  @@map("bot_activities")
}

// Bot accounts (managed by the bot)
model BotAccount {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contract identification
  contractId String // BNPL contract ID

  // Account identification
  name      String   // e.g., "merchant-1", "user-5"
  address   String   // Stellar public key
  type      BotAccountType

  // State tracking
  isActive       Boolean @default(true)
  lastUsed       DateTime?

  // For merchants
  mongoId         String?   // MerchantApplication MongoDB ID
  merchantStatus  String?   // pending, approved, rejected
  billsCreated    Int       @default(0)

  // For users
  lpDeposited     Float     @default(0)  // LP tokens held
  activeBills     Int[]     // Active bill IDs

  @@unique([contractId, name])
  @@unique([contractId, address])
  @@index([contractId])
  @@index([type])
  @@index([merchantStatus])
  @@map("bot_accounts")
}

enum BotAccountType {
  ADMIN
  MERCHANT
  USER
}

// Bot daily metrics aggregation
model BotDailyMetrics {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime @default(now())

  // Contract identification
  contractId String // BNPL contract ID

  // Date for the metrics
  date      String   // YYYY-MM-DD

  // Transaction counts
  totalTx         Int @default(0)
  successfulTx    Int @default(0)
  failedTx        Int @default(0)

  // Scenario breakdown
  bootstrapCount    Int @default(0)
  lpDepositCount    Int @default(0)
  lpWithdrawCount   Int @default(0)
  bnplCreateCount   Int @default(0)
  bnplPayCount      Int @default(0)
  bnplRepayCount    Int @default(0)

  // Goal snapshots at end of day
  endOfDayTvl           Float?
  endOfDayMerchants     Int?
  endOfDayUsers         Int?

  @@unique([contractId, date])
  @@index([contractId])
  @@map("bot_daily_metrics")
}

// ============================================
// Checkout API Models
// ============================================

// Merchant settings for Checkout API
model Merchant {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Identification
  address       String    @unique  // Stellar wallet address

  // Display info
  name          String    @default("Merchant")

  // Webhook configuration
  webhookSecret String?   // Secret for signing webhooks (whsec_...)

  // Relations
  apiKeys       MerchantApiKey[]
  sessions      CheckoutSession[]

  @@map("merchants")
}

// Merchant API keys for external integration
model MerchantApiKey {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime  @default(now())

  // Owner identification
  merchantId    String    // Wallet address of the merchant

  // Key properties
  name          String    @default("Default")
  keyPrefix     String    // "ll_live_" or "ll_test_"
  keyHash       String    // SHA256 hash of full key (for lookup)

  // Status tracking
  lastUsedAt    DateTime?
  expiresAt     DateTime
  revokedAt     DateTime?

  // Relation to merchant
  merchant      Merchant? @relation(fields: [merchantId], references: [address])

  @@index([merchantId])
  @@index([keyHash])
  @@map("merchant_api_keys")
}

// Checkout sessions for redirect-based payment flow
model CheckoutSession {
  id        String    @id @map("_id") // "cs_" + cuid() - custom ID format

  createdAt DateTime  @default(now())

  // Merchant info
  merchantId    String    // Wallet address of the merchant

  // Payment details
  amount        Float     // Amount in USDC (7 decimals)
  orderId       String?   // Merchant's order reference
  description   String?   // Description shown to user

  // Redirect URLs
  successUrl    String    // URL to redirect after successful payment
  cancelUrl     String    // URL to redirect if user cancels
  webhookUrl    String?   // URL for webhook notifications

  // Custom data
  metadata      Json?     // Arbitrary merchant data

  // Session status
  status        CheckoutSessionStatus @default(PENDING)
  expiresAt     DateTime  // 1 hour from creation

  // Completion info
  billId        String?   // On-chain bill ID after completion
  txHash        String?   // Transaction hash
  completedAt   DateTime?
  userAddress   String?   // Address of the user who paid

  // Relations
  merchant      Merchant? @relation(fields: [merchantId], references: [address])
  webhookDeliveries WebhookDelivery[]

  @@index([merchantId])
  @@index([status])
  @@index([expiresAt])
  @@map("checkout_sessions")
}

enum CheckoutSessionStatus {
  PENDING     // Waiting for user to pay
  COMPLETED   // Payment successful
  EXPIRED     // Session timed out
  CANCELLED   // User cancelled
}

// Webhook delivery log
model WebhookDelivery {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  createdAt DateTime  @default(now())

  // Related session
  sessionId     String    // CheckoutSession ID
  session       CheckoutSession? @relation(fields: [sessionId], references: [id])

  // Delivery details
  webhookUrl    String
  payload       Json
  signature     String    // For verification

  // Status
  status        WebhookDeliveryStatus @default(PENDING)
  attempts      Int       @default(0)
  lastAttemptAt DateTime?
  nextRetryAt   DateTime?
  responseCode  Int?
  responseBody  String?

  @@index([sessionId])
  @@index([status])
  @@index([nextRetryAt])
  @@map("webhook_deliveries")
}

enum WebhookDeliveryStatus {
  PENDING
  DELIVERED
  FAILED
}