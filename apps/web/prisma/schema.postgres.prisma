// Prisma schema for PostgreSQL - Event Indexer (Goldsky)
//
// This is a separate schema for event data streamed by Goldsky Mirror.
// App data (merchants, bills, etc.) remains in MongoDB (schema.prisma)
//
// Generate client: npx prisma generate --schema=prisma/schema.postgres.prisma
// Push schema: npx prisma db push --schema=prisma/schema.postgres.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-postgres"
}

datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_URL")
}

/// Contract events indexed by Goldsky Mirror from stellar_testnet.events
/// Table is auto-created by Goldsky pipeline, schema here for type safety
model ContractEvent {
  id                       String  @id
  type                     String? // Event type (contract, diagnostic, etc.)
  contractId               String  @map("contract_id")
  topics                   String? // Event topics (JSON string)
  data                     String? // Event data payload (JSON string)
  inSuccessfulContractCall Boolean @default(true) @map("in_successful_contract_call")

  // Transaction info
  transactionHash       String  @map("transaction_hash")
  transactionAccount    String? @map("transaction_account")
  transactionFeeAccount String? @map("transaction_fee_account")
  transactionSuccessful Boolean @default(true) @map("transaction_successful")

  // Operation info
  operationBody       String? @map("operation_body")
  operationResultCode String? @map("operation_result_code")
  operationType       String? @map("operation_type")

  // Ledger info
  ledgerSequence BigInt  @map("ledger_sequence")
  ledgerHash     String? @map("ledger_hash")
  ledgerClosedAt BigInt  @map("ledger_closed_at") // Unix timestamp in ms
  ledgerSignature String? @map("ledger_signature")

  @@index([contractId])
  @@index([ledgerSequence])
  @@index([transactionHash])
  @@map("contract_events")
}

/// Protocol metrics snapshot (aggregated from events)
model ProtocolSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Metrics
  totalEvents       Int @default(0) @map("total_events")
  totalUsers        Int @default(0) @map("total_users")
  totalMerchants    Int @default(0) @map("total_merchants")
  totalTransactions Int @default(0) @map("total_transactions")

  // By contract
  bnplCoreEvents  Int @default(0) @map("bnpl_core_events")
  lpTokenEvents   Int @default(0) @map("lp_token_events")
  usdcTokenEvents Int @default(0) @map("usdc_token_events")

  // Ledger info
  latestLedger BigInt? @map("latest_ledger")

  @@index([createdAt])
  @@map("protocol_snapshots")
}
