// Prisma schema for PostgreSQL - Event Indexer (Goldsky)
//
// This schema matches Goldsky's stellar_testnet.events dataset structure
// Events are streamed by Goldsky Mirror pipeline
//
// Generate client: npx prisma generate --schema=prisma/schema.postgres.prisma
// Push schema: npx prisma db push --schema=prisma/schema.postgres.prisma

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/@prisma/client-postgres"
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_URL")
  directUrl = env("POSTGRES_URL_DIRECT")
}

/// Contract events indexed by Goldsky Mirror from stellar_testnet.events
model ContractEvent {
  id                       String  @id
  type                     String? // Event type (contract, diagnostic, etc.)
  contractId               String  @map("contract_id")
  topics                   String? // Event topics (JSON string)
  data                     String? // Event data payload (JSON string)
  inSuccessfulContractCall Boolean @default(true) @map("in_successful_contract_call")

  // Transaction info
  transactionHash       String  @map("transaction_hash")
  transactionAccount    String? @map("transaction_account")
  transactionFeeAccount String? @map("transaction_fee_account")
  transactionSuccessful Boolean @default(true) @map("transaction_successful")

  // Operation info
  operationBody       String? @map("operation_body")
  operationResultCode String? @map("operation_result_code")
  operationType       String? @map("operation_type")

  // Ledger info
  ledgerSequence  BigInt   @map("ledger_sequence")
  ledgerHash      String?  @map("ledger_hash")
  ledgerClosedAt  DateTime @map("ledger_closed_at")
  ledgerSignature String?  @map("ledger_signature")

  @@index([contractId])
  @@index([ledgerSequence])
  @@index([transactionHash])
  @@map("contract_events")
}

/// Protocol metrics snapshot (aggregated from events)
model ProtocolSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // Metrics
  totalEvents       Int @default(0) @map("total_events")
  totalUsers        Int @default(0) @map("total_users")
  totalMerchants    Int @default(0) @map("total_merchants")
  totalTransactions Int @default(0) @map("total_transactions")

  // By contract
  bnplCoreEvents  Int @default(0) @map("bnpl_core_events")
  lpTokenEvents   Int @default(0) @map("lp_token_events")
  usdcTokenEvents Int @default(0) @map("usdc_token_events")

  // Ledger info
  latestLedger BigInt? @map("latest_ledger")

  @@index([createdAt])
  @@map("protocol_snapshots")
}

/// Parsed bill events from BNPL contract
model ParsedBill {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Bill identification
  billId     BigInt @unique @map("bill_id") // On-chain bill ID
  contractId String @map("contract_id")

  // Participants
  merchant String // Merchant address
  user     String // User/Buyer address

  // Bill details
  amount  BigInt // Amount in stroops
  orderId String @map("order_id")

  // Status tracking (updated by events)
  status        BillStatus @default(CREATED)
  paidAt        DateTime?  @map("paid_at")
  repaidAt      DateTime?  @map("repaid_at")
  liquidatedAt  DateTime?  @map("liquidated_at")

  // Repayment info
  amountRepaid BigInt? @map("amount_repaid") // Amount actually repaid (including fees)

  // Loan info (populated when paid via BNPL)
  loanId BigInt? @map("loan_id")

  // Source event reference
  sourceEventId String  @map("source_event_id")
  ledgerSequence BigInt @map("ledger_sequence")
  txHash         String @map("tx_hash")

  @@index([contractId])
  @@index([merchant])
  @@index([user])
  @@index([status])
  @@index([ledgerSequence])
  @@map("parsed_bills")
}

enum BillStatus {
  CREATED
  PAID
  REPAID
  LIQUIDATED
}

/// Parsed merchant events from BNPL contract
model ParsedMerchant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Merchant identification
  address    String @unique // Merchant Stellar address
  contractId String @map("contract_id")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  enrolledAt DateTime @map("enrolled_at")

  // Source event reference
  sourceEventId  String @map("source_event_id")
  ledgerSequence BigInt @map("ledger_sequence")
  txHash         String @map("tx_hash")

  @@index([contractId])
  @@index([isActive])
  @@map("parsed_merchants")
}
