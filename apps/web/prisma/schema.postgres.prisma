// Prisma schema for PostgreSQL - Event Indexer (Goldsky)
//
// This schema matches Goldsky's stellar_testnet.events dataset structure
// Events are streamed by Goldsky Mirror pipeline
//
// Generate client: npx prisma generate --schema=prisma/schema.postgres.prisma
// Push schema: npx prisma db push --schema=prisma/schema.postgres.prisma

generator client {
  provider      = "prisma-client-js"
  output        = "../node_modules/@prisma/client-postgres"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_DIRECT")
}

/// Contract events indexed by Goldsky Mirror from stellar_testnet.events
model ContractEvent {
  id                       String  @id
  type                     String? // Event type (contract, diagnostic, etc.)
  contractId               String  @map("contract_id")
  topics                   String? // Event topics (JSON string)
  data                     String? // Event data payload (JSON string)
  inSuccessfulContractCall Boolean @default(true) @map("in_successful_contract_call")

  // Transaction info
  transactionHash       String  @map("transaction_hash")
  transactionAccount    String? @map("transaction_account")
  transactionFeeAccount String? @map("transaction_fee_account")
  transactionSuccessful Boolean @default(true) @map("transaction_successful")

  // Operation info
  operationBody       String? @map("operation_body")
  operationResultCode String? @map("operation_result_code")
  operationType       String? @map("operation_type")

  // Ledger info
  ledgerSequence  BigInt   @map("ledger_sequence")
  ledgerHash      String?  @map("ledger_hash")
  ledgerClosedAt  DateTime @map("ledger_closed_at")
  ledgerSignature String?  @map("ledger_signature")

  @@index([contractId])
  @@index([ledgerSequence])
  @@index([transactionHash])
  @@map("contract_events")
}

/// Protocol metrics snapshot (hourly cron job)
model ProtocolSnapshot {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")

  // ===== Contract Identification =====
  contractId String @map("contract_id") // BNPL contract ID for this snapshot

  // ===== Liquidity Pool =====
  poolTvl         BigInt?  @map("pool_tvl")          // Total Value Locked (stroops)
  poolUtilization Decimal? @map("pool_utilization") @db.Decimal(5, 2) // Outstanding / TVL (%)
  poolApyDaily    Decimal? @map("pool_apy_daily")   @db.Decimal(8, 4)
  poolApyMonthly  Decimal? @map("pool_apy_monthly") @db.Decimal(8, 4)
  poolApyTotal    Decimal? @map("pool_apy_total")   @db.Decimal(8, 4)

  // ===== Bills =====
  billsTotal      Int @default(0) @map("bills_total")
  billsCreated    Int @default(0) @map("bills_created")    // Pending payment
  billsPaid       Int @default(0) @map("bills_paid")       // Active loans
  billsRepaid     Int @default(0) @map("bills_repaid")     // Completed
  billsLiquidated Int @default(0) @map("bills_liquidated") // Defaulted

  // ===== Volume (stroops) =====
  volume24h   BigInt @default(0) @map("volume_24h")
  volume7d    BigInt @default(0) @map("volume_7d")
  volume30d   BigInt @default(0) @map("volume_30d")
  volumeTotal BigInt @default(0) @map("volume_total")

  // ===== Fees (stroops) =====
  fees24h   BigInt @default(0) @map("fees_24h")
  fees7d    BigInt @default(0) @map("fees_7d")
  fees30d   BigInt @default(0) @map("fees_30d")
  feesTotal BigInt @default(0) @map("fees_total")

  // Fee Distribution (calculated from feesTotal)
  feesToLp        BigInt @default(0) @map("fees_to_lp")        // 70%
  feesToTreasury  BigInt @default(0) @map("fees_to_treasury")  // 20%
  feesToInsurance BigInt @default(0) @map("fees_to_insurance") // 10%

  // ===== Participants =====
  uniqueUsers        Int @default(0) @map("unique_users")
  uniqueMerchants    Int @default(0) @map("unique_merchants")
  activeUsers24h     Int @default(0) @map("active_users_24h")
  activeMerchants24h Int @default(0) @map("active_merchants_24h")

  // ===== Health Metrics =====
  totalOutstanding    BigInt?  @map("total_outstanding")     // Outstanding loans (stroops)
  avgBillAmount       BigInt?  @map("avg_bill_amount")       // Average bill size
  repaymentRate       Decimal? @map("repayment_rate") @db.Decimal(5, 2)       // %
  defaultRate         Decimal? @map("default_rate")  @db.Decimal(5, 2)        // %
  avgRepaymentTimeHrs Int?     @map("avg_repayment_time_hrs") // Hours

  // ===== Ledger Info =====
  latestLedger BigInt? @map("latest_ledger")

  @@index([createdAt])
  @@index([contractId])
  @@index([contractId, createdAt])
  @@map("protocol_snapshots")
}

/// Parsed bill events from BNPL contract
model ParsedBill {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Bill identification
  billId     BigInt @unique @map("bill_id") // On-chain bill ID
  contractId String @map("contract_id")

  // Participants
  merchant String // Merchant address
  user     String // User/Buyer address

  // Bill details
  amount  BigInt // Amount in stroops
  orderId String @map("order_id")

  // Status tracking (updated by events)
  status        BillStatus @default(CREATED)
  paidAt        DateTime?  @map("paid_at")
  repaidAt      DateTime?  @map("repaid_at")
  liquidatedAt  DateTime?  @map("liquidated_at")

  // Repayment info
  amountRepaid BigInt? @map("amount_repaid") // Amount actually repaid (including fees)

  // Loan info (populated when paid via BNPL)
  loanId BigInt? @map("loan_id")

  // Source event reference
  sourceEventId String  @map("source_event_id")
  ledgerSequence BigInt @map("ledger_sequence")
  txHash         String @map("tx_hash")

  @@index([contractId])
  @@index([merchant])
  @@index([user])
  @@index([status])
  @@index([ledgerSequence])
  @@map("parsed_bills")
}

enum BillStatus {
  CREATED
  PAID
  REPAID
  LIQUIDATED
}

/// Parsed merchant events from BNPL contract
model ParsedMerchant {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Merchant identification
  address    String @unique // Merchant Stellar address
  contractId String @map("contract_id")

  // Status
  isActive   Boolean @default(true) @map("is_active")
  enrolledAt DateTime @map("enrolled_at")

  // Source event reference
  sourceEventId  String @map("source_event_id")
  ledgerSequence BigInt @map("ledger_sequence")
  txHash         String @map("tx_hash")

  @@index([contractId])
  @@index([isActive])
  @@map("parsed_merchants")
}
